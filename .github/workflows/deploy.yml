name: Deploy to InfinityFree

on:
  push:
    branches:
      - master
      - develop

jobs:
  deploy-master:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create conexion.php for MASTER
        run: |
          mkdir -p config
          cat > config/conexion.php <<'PHP'
          <?php
              $host     = '${{ secrets.DB_HOST_MASTER }}';
              $bbdd     = '${{ secrets.DB_NAME_MASTER }}';
              $user     = '${{ secrets.DB_USER_MASTER }}';
              $password = '${{ secrets.DB_PASS_MASTER }}';
              $charset  = 'utf8mb4';
              $db = new mysqli($host, $user, $password, $bbdd);
              $db->set_charset('utf8');
              if ($db->connect_error) { die('Connection failed'); }
          ?>
          PHP

      - name: Deploy to MASTER domain
        uses: SamKirkland/FTP-Deploy-Action@v4.3.3
        with:
          server: ${{ secrets.FTP_SERVER_MASTER }}
          username: ${{ secrets.FTP_USERNAME_MASTER }}
          password: ${{ secrets.FTP_PASSWORD_MASTER }}
          server-dir: ${{ secrets.FTP_PATH_MASTER }}
          local-dir: ./        # Carpeta raíz del repo
          exclude: |
            .git
            .github
            tests
            *.yml
            *.yaml

  deploy-develop:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create conexion.php for DEV
        run: |
          mkdir -p config
          cat > config/conexion.php <<'PHP'
          <?php
              $host     = '${{ secrets.DB_HOST_DEV }}';
              $bbdd     = '${{ secrets.DB_NAME_DEV }}';
              $user     = '${{ secrets.DB_USER_DEV }}';
              $password = '${{ secrets.DB_PASS_DEV }}';
              $charset  = 'utf8mb4';
              $db = new mysqli($host, $user, $password, $bbdd);
              $db->set_charset('utf8');
              if ($db->connect_error) { die('Connection failed'); }
          ?>
          PHP

      - name: Deploy to DEVELOP domain
        uses: SamKirkland/FTP-Deploy-Action@v4.3.3
        with:
          server: ${{ secrets.FTP_SERVER_DEV }}
          username: ${{ secrets.FTP_USERNAME_DEV }}
          password: ${{ secrets.FTP_PASSWORD_DEV }}
          server-dir: ${{ secrets.FTP_PATH_DEV }}
          local-dir: ./        # Carpeta raíz del repo
          exclude: |
            .git
            .github
            tests
            *.yml
            *.yaml
